// Registrar process
digraph {
  subgraph cluster_Registrar {
    label="Registrar"
    r_list_slots [label="list_slots"]
    r_schedule_appointment [label="schedule_appointment"]
    r_verify_identity [label="verify_identity"]
    r_check_eligibility [label="check_eligibility"]
    r_issue_signature [label="issue_signature"]
    r_verify_identity -> r_issue_signature [constraint="false"]
  }

  // Step 1
  create [shape="diamond"]
  Identity [label="Identity and registrar combination" shape="box"]

  create -> Identity

  keygen [shape="diamond"]
  Public [label="Poller public key" shape="box"]
  Private [label="Poller private key" shape="box"]

  keygen -> Public
  keygen -> Private

  calendar [shape="diamond"]
  Appointments [label="Available appointments" shape="box"]
  calendar -> r_list_slots -> Appointments

  Appointments -> Request1
  Identity -> Request1
  Request1 [label="Choose an appointment." shape="diamond"]
  Request1 -> r_check_eligibility // [label="Request acknowledgement of eligibility"]

  CheckEligibility [label="check_eligibility" shape="diamond"]
  r_check_eligibility -> CheckEligibility [style="dotted"]
  Identity -> CheckEligibility -> Subkey

  Subkey [label="Subkey for key-blinding" shape="box"]
  Salt [label="Salt for blinding" shape="box"]

  Blinded [label="Poller Blinded key" shape="box"]
  Subkey -> Blinded
  Salt -> Blinded
  Public -> Blinded

  schedule_appointment [shape="diamond"]
  Identity -> schedule_appointment
  Blinded  -> schedule_appointment -> r_schedule_appointment
  r_schedule_appointment -> Confirmation [style=dotted]
  Identity -> Confirmation
  Confirmation [label="Confirm appointment" shape="diamond"]

  // Step 2
  Confirmation -> r_verify_identity
  Identity -> get_signature
  get_signature [shape="diamond"]
  get_signature -> r_issue_signature [style=dotted]
  r_issue_signature -> SignedBlinded
  SignedBlinded [label="Signature of blinded blob" shape="box"]

  Salt -> Unblinded
  Subkey -> Unblinded
  SignedBlinded -> Unblinded

  Unblinded [shape="hexagon" label="Unblinded key"]
}
